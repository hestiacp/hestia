#!/bin/bash
# info: add firewall blocking rule
# options: IP CHAIN
#
# example: v-add-firewall-ban 37.120.129.20 MAIL
#
# This function adds new blocking rule to system firewall

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
ip46="$1"
chain=$(echo $2 | tr '[:lower:]' '[:upper:]')

subnetcalc_bin="$(which subnetcalc)" # subnetcalc binary to calculate subnet of an ipv6 net

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source "$HESTIA/func/main.sh"
# shellcheck source=/usr/local/hestia/func/firewall.sh
source "$HESTIA/func/firewall.sh"
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'IP CHAIN'
is_format_valid 'ip46' 'chain'
is_system_enabled "$FIREWALL_SYSTEM" 'FIREWALL_SYSTEM'

ip_format=$(get_ip_format "$ip46") # ip verification and format identification
case "$ip_format" in
	4)
		ipfamily="inet4"
		iptables="iptables"
		ip2ban="$ip46"
		reject_with="icmp-port-unreachable"
		;;
	6)
		ipfamily="inet6"
		iptables="ip6tables"
		[ -x "$subnetcalc_bin" ] && ip2ban="${ip46}/64" || ip2ban="$ip46" # subnet ban of /64 net only if subnetcalc binary is installed
		reject_with="icmp6-port-unreachable"
		;;
	*)
		check_result 1 "Wrong IP address $ip46 !" # wrong ip address
		;;
esac

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Self heal iptables links
heal_iptables_links

# Checking server ip
if [ -e "$HESTIA/data/ips/$ip46" ] || [ "$ip46" = '127.0.0.1' ] || [ "$ip46" = '::1' ] || [ "$ip46" = '0:0:0:0:0:0:0:1' ]; then
	exit
fi

# Checking ip exclusions
excludes="$HESTIA/data/firewall/excludes.conf"
check_excludes=$(grep "^$ip46$" $excludes 2> /dev/null)
if [ -n "$check_excludes" ]; then
	exit
fi

# Checking ip in banlist
conf="$HESTIA/data/firewall/banlist.conf"
check_ip=$(grep "IP='$ip46' CHAIN='$chain'" $conf 2> /dev/null)
if [ -n "$check_ip" ]; then
	exit
fi

# Adding chain
"$BIN/v-add-firewall-chain" "$chain" "" "" "$ipfamily" "$iptables"

# Get iptables binary
iptables="$(get_iptables_bin "$iptables")"

# Generating timestamp
time_n_date=$(date +'%T %F')
time=$(echo "$time_n_date" | cut -f 1 -d \ )
date=$(echo "$time_n_date" | cut -f 2 -d \ )

# Adding ip to banlist
echo "IP='$ip46' CHAIN='$chain' TIME='$time' DATE='$date'" >> "$conf"
error_message="$(${iptables} -I "fail2ban-${chain}" 1 -s "$ip2ban" -j REJECT --reject-with "$reject_with")"
if [ $? -ne 0 ]; then
	error_code=$?
	check_result 1 "$error_message"
	exit $error_code
fi

# Changing permissions
chmod 660 "$conf"

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Logging
"$BIN/v-log-action" "system" "Warning" "Firewall" "Banned IP address $ip46."
log_event "$OK" "$ARGUMENTS"

exit
