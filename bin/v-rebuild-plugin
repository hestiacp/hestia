#!/usr/bin/env bash
# info: rebuild a plugin
# options: PLUGIN_NAME
#
# example: v-rebuild-plugin pluginname

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

plugin_name="$1"

# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# shellcheck source=/usr/local/hestia/func/plugins.sh
source $HESTIA/func/plugins.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'PLUGIN_NAME'

init_plugins_conf_if_not_exists

plugin_name="$(echo "$plugin_name" | awk '{gsub(/^[ \t]+| [ \t]+$/,""); print $0 }')"
plugin_path="$HESTIA/plugins/$plugin_name"
plugin_conf="$($HESTIA/bin/v-list-plugin "$plugin_name" plain)"

if [[ -z "$plugin_conf" ]]; then
	check_result "$E_INVALID" "Plugin $plugin_name does not exist"
elif [[ "$(echo "$plugin_conf" | awk '{print $4}')" != "true" ]]; then
	check_result "$E_INVALID" "Plugin $plugin_name is disabled"
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

mkdir -p $HESTIA/web/plugin

if [[ ! -d "$plugin_path" ]]; then
	plugin_repo="$(echo "$plugin_conf" | awk '{print $3}')"
	if [[ "$plugin_repo" && "$plugin_repo" != "null" ]]; then
		echo "Plugin $plugin_name not found, reinstalling via $plugin_repo"
		$HESTIA/bin/v-add-plugin "$plugin_repo"
	else
		echo "Plugin $plugin_name not found and don't have a repository in their configs."
	fi
else
	echo "Configuring plugin $plugin_name"

	# Create symbolic links to executables
	if [[ -d "$plugin_path/bin" && -n "$(ls "$plugin_path/bin/v-plugin-"* 2> /dev/null)" ]]; then
		for f in "$plugin_path/bin/v-plugin-"*; do
			bin_name="$(basename -- "$f")"

			# Check if already a script with that name
			if [[ ! -e "$HESTIA/bin/$bin_name" ]]; then
				chmod +x "$f"
				ln -s "$f" $HESTIA/bin
			fi
		done
	fi

	# Create symbolic link to the web directory
	if [[ -d "$plugin_path/web" ]]; then
		if [[ -L "$HESTIA/web/plugin/$plugin_name" ]]; then
			unlink "$HESTIA/web/plugin/$plugin_name"
		fi

		ln -s "$plugin_path/web" "$HESTIA/web/plugin/$plugin_name"
	fi
fi
