#!/bin/bash
# info: WordPress installer in one command line
# options: USER DOMAIN EMAIL USERNAME PASSWORD
# EMAIL USERNAME and PASSWORD are for WordPress credentials. The database creadentials are generated automatically
# TESTED WITH HTTPS. 
#
# Credits to Luka PaunoviÄ‡ for wp-cli implememtation for VESTA
# Credits to Mawaki Bidjada for adapting to v-intall-wordpress from VESTA TO HESTIA
# This needs check_if_database_exists() and generate_password() added to db.sh or another file which will be imported here

#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Importing system environment
source /etc/profile


# Argument definition
user=$1
domain=$2
email=$3
username=$4
password=$5


domain_user=$(/usr/local/hestia/bin/v-search-domain-owner $domain)
USER=$domain_user

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# database
source /usr/local/hestia/func/db.sh
source /usr/local/hestia/func/handle_parameters.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

if [ -z "$domain" ]; then
    check_result $E_NOTEXIST "domain $domain doesn't exist"
fi

if [ "$user" != "$domain_user" ]; then
  check_result $E_NOTEXIST "domain $domain doesn't exist for this user"
fi

if [[ $(is_package_full 'DATABASES') = *reached* ]]; then
        echo "Database limit is reached. Delete database or upgrade user package."
        exit
fi

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# 4 arguments are required
check_args '5' "$#" 'USER DOMAIN EMAIL USERNAME PASSWORD'
is_format_valid 'user' 'domain'
is_object_valid 'user' 'USER' "$user"
is_object_unsuspended 'user' 'USER' "$user"
is_object_valid 'web' 'DOMAIN' "$domain"
is_object_unsuspended 'web' 'DOMAIN' "$domain"

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

# take --parameters
source /usr/local/hestia/func/handle_parameters.sh

if [ -z "$database" ]; then
    if [ ! -z "$MAX_DBUSER_LEN" ] && [ "$MAX_DBUSER_LEN" -ge 80  ]; then
        database=$(echo "$domain" | sed 's#\.#_#g')
    else
       database="wp"
    fi
fi

if [ -z "$email" ]; then
    email="info@$domain";
fi

if [ ! -d "/home/$user" ]; then
    echo "User doesn't exist";
    exit 1;
fi

if [ ! -d "/home/$user/web/$domain/public_html" ]; then
    echo "Domain doesn't exist";
    exit 1;
fi

DBUSERSUF="$database";
DBUSERSUFB="$database";
DBUSER=$user\_$DBUSERSUFB;
DB_EXISTS=$(check_if_database_exists "$user" "$DBUSER")

if [ "$DB_EXISTS" = "yes" ]; then
    # echo "Database already exists"
    i=1;
    while [ $i -lt 99 ]; do
        i=$((i+1));
        DBUSERSUF="${DBUSERSUFB}${i}";
        DBUSER=$user\_$DBUSERSUF;
        DB_EXISTS=$(check_if_database_exists "$user" "$DBUSER")
        if [ "$DB_EXISTS" = "no" ]; then
            break;
        fi
    done
fi

PASSWDDB=$(generate_password)

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Load domain data
parse_object_kv_list $(grep "DOMAIN='$domain'" $USER_DATA/web.conf)
# echo "ssl is $SSL"

PROTOCOL='http'
if [ -z "$SKIP_LE" ]; then
    if [ "$SSL" != 'yes' ]; then
        /usr/local/hestia/bin/v-add-letsencrypt-domain "$user" "$domain" "www.$domain" "yes"
    else
      PROTOCOL='https'
    fi
else
    PROTOCOL='https'
fi

# change template if needed
TPL_CHANGED=0;

if [ -f "/home/$user/conf/web/$domain/ssl/$domain.ca" ] || [ ! -z "$SKIP_LE" ]; then
    PROTOCOL='https'
    if [ -f "/usr/local/hestia/data/templates/web/nginx/force-https-firewall-wordpress.stpl" ] && [ $TPL_CHANGED -eq 0 ]; then
        TPL_CHANGED=1;
        /usr/local/hestia/bin/v-change-web-domain-proxy-tpl  "$user" "$domain" "force-https-firewall-wordpress" "jpeg,jpg,png,gif,bmp,ico,svg,tif,tiff,css,js,ttf,otf,webp,txt,csv,rtf,doc,docx,xls,xlsx,ppt,pptx,odf,odp,ods,odt,pdf,psd,ai,eot,eps,ps,zip,tar,tgz,gz,rar,bz2,7z,aac,m4a,mp3,mp4,ogg,wav,wma,3gp,avi,flv,m4v,mkv,mov,mpeg,mpg,wmv,exe,iso,dmg,swf,woff,woff2" "yes"
    fi
    if [ -f "/usr/local/hestia/data/templates/web/nginx/force-https.stpl" ] && [ $TPL_CHANGED -eq 0 ]; then
        TPL_CHANGED=1;
        /usr/local/hestia/bin/v-change-web-domain-proxy-tpl  "$user" "$domain" "force-https" "jpeg,jpg,png,gif,bmp,ico,svg,tif,tiff,css,js,ttf,otf,webp,txt,csv,rtf,doc,docx,xls,xlsx,ppt,pptx,odf,odp,ods,odt,pdf,psd,ai,eot,eps,ps,zip,tar,tgz,gz,rar,bz2,7z,aac,m4a,mp3,mp4,ogg,wav,wma,3gp,avi,flv,m4v,mkv,mov,mpeg,mpg,wmv,exe,iso,dmg,swf,woff,woff2" "yes"
    fi
else
    if [ -f "/usr/local/hestia/data/templates/web/nginx/hosting.stpl" ] && [ $TPL_CHANGED -eq 0 ]; then
        TPL_CHANGED=1;
        /usr/local/hestia/bin/v-change-web-domain-proxy-tpl  "$user" "$domain" "hosting" "jpeg,jpg,png,gif,bmp,ico,svg,tif,tiff,css,js,ttf,otf,webp,txt,csv,rtf,doc,docx,xls,xlsx,ppt,pptx,odf,odp,ods,odt,pdf,psd,ai,eot,eps,ps,zip,tar,tgz,gz,rar,bz2,7z,aac,m4a,mp3,mp4,ogg,wav,wma,3gp,avi,flv,m4v,mkv,mov,mpeg,mpg,wmv,exe,iso,dmg,swf,woff,woff2" "yes"
    fi
fi

echo "Creating database" >> /var/log/v-wordpress.log
# CREATE DATABASE
/usr/local/hestia/bin/v-add-database "$user" "$DBUSERSUF" "$DBUSERSUF" "$PASSWDDB" "mysql"

if [ ! -f "/usr/local/bin/wp" ]; then
    echo "=== Downloading latest wp-cli"
    wget -nv https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar -O /usr/local/bin/wp
    chmod +x /usr/local/bin/wp
fi


echo "Starting installation v-install-wordpress" >> /var/log/v-wordpress.log
# INSTALLATION
WORKINGDIR="/home/$user/web/$domain/public_html"
rm -rf $WORKINGDIR/*
cd $WORKINGDIR

sudo -H -u$user wp core download
sudo -H -u$user wp core config --dbname=$DBUSER --dbuser=$DBUSER --dbpass=$PASSWDDB


wpadmin=$username
wppassword=$password

sudo -H -u$user wp core install --url="$domain" --title="$domain" --admin_user="$wpadmin" --admin_password="$wppassword" --admin_email="$email" --path=$WORKINGDIR

mysql -u$DBUSER -p$PASSWDDB -e "USE $DBUSER; update wp_options set option_value = '$PROTOCOL://$domain' where option_name = 'siteurl'; update wp_options set option_value = '$PROTOCOL://$domain' where option_name = 'home';"

echo "================================================================="
echo "Installation is complete. Your username/password is listed below."
echo ""
echo "Site: $PROTOCOL://$domain/"
echo ""
echo "Login: $PROTOCOL://$domain/wp-admin/"
echo "Username: $wpadmin"
echo "Password: $password"
echo ""
echo "================================================================="

chown -R $user:$user $WORKINGDIR

#----------------------------------------------------------#
#                       Hestia                              #
#----------------------------------------------------------#

echo "v-install-wordpress: Done."
echo "Finished installation v-install-wordpress" >> /var/log/v-wordpress.log
log_event "$OK" "$ARGUMENTS"

exit



