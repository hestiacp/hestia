#!/bin/bash
# info: add user ssh jail
# options: USER [RESTART]
#
# example: v-add-user-ssh-jail admin
#
# This function enables ssh jailed environment

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1
shell=$2
restart=$3

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

chroot="/srv/jail/$user"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Checking if jailkit is installed
if [ ! -x /sbin/jk_init ]; then
	exit
fi

check_args '1' "$#" 'USER'
is_format_valid 'user'

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Get shell full path
shell_path=$(grep -w "$shell" /etc/shells | head -n1)

# Set home folder permission to root
if [ -d "/home/$user" ]; then
	chown root:root /home/$user
fi

add_chroot_jail "$user"

# Installing shell files into the user chroot directory
# - IMPORTANT - MODIFY THE FOLLOWING LINES AND THE FILE jk_init.ini ACCORDING TO YOUR SYSTEM AND YOUR PREFERENCES
/sbin/jk_init -f -j $chroot basicshell editors extendedshell netutils ssh sftp scp git
/sbin/jk_cp -f -j $chroot /bin/id

# Jailing user
/sbin/jk_jailuser -n -s $shell_path -j $chroot $user

# Reset home directory and shell again for hestiacp because jailkit changes these
usermod -d /home/$user $user
usermod -s $shell_path $user

# Adding the user to the chroot /etc/passwd if it wasn't added yet
if [ -z "$(grep "^$user:" $chroot/etc/passwd | egrep "$shell")" ]; then
	echo $(grep "^$user:" /etc/passwd | egrep "$shell") >> $chroot/etc/passwd
fi

# Adding the user to the chroot /etc/group if it wasn't added yet
if [ -z "$(grep "^$user:" $chroot/etc/group)" ]; then
	echo $(grep "^$user:" /etc/group) >> $chroot/etc/group
fi

# Add user to the ssh-jailed group to allow jailed ssh
usermod -a -G ssh-jailed $user

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Restart ssh service
if [ "$restart" = 'no' ]; then
	# Skip restart of SSH daemon
	echo "" > /dev/null 2>&1
else
	service sshd restart > /dev/null 2>&1
fi

# Logging
log_event "$OK" "$ARGUMENTS"

exit
