#!/bin/bash
# info: delete firewall blocking rule
# options: IP CHAIN
#
# example: v-delete-firewall-ban 198.11.130.250 MAIL
#
# This function deletes blocking rule from system firewall

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
ip46="$1"
chain=$(echo "$2" | tr '[:lower:]' '[:upper:]')

subnetcalc_bin="$(which subnetcalc)" # subnetcalc binary to calculate subnet of an ipv6 net

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source "$HESTIA/func/main.sh"
# shellcheck source=/usr/local/hestia/func/firewall.sh
source "$HESTIA/func/firewall.sh"
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'IP CHAIN'
is_format_valid 'ip46' 'chain'
is_system_enabled "$FIREWALL_SYSTEM" 'FIREWALL_SYSTEM'

ip_format=$(get_ip_format "$ip46") # ip verification and format identification
case "$ip_format" in
	4)
		iptables="iptables"
		ip2ban="$ip46"
		;;
	6)
		iptables="ip6tables"
		if [ -x "$subnetcalc_bin" ]; then
			# if subnetcalc binary is installed on system, then ban of whole /64 subnet
			ip2ban="$("$subnetcalc_bin" "${ip46}/64" | sed -ne '/Network/s/Network[ \t]*=[ \t]*\(.*\)/\1/p' | sed -e 's/[ \t]*//g')"
		else
			# otherwise ban the ip only, without subnet
			ip2ban="$ip46"
		fi
		;;
	*)
		check_result 1 "Wrong IP address $ip46 !" # wrong ip address
		;;
esac

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Self heal iptables links
heal_iptables_links

# Get iptables binary
iptables="$(get_iptables_bin "$iptables")"

conf="$HESTIA/data/firewall/banlist.conf"
error_message="Banned address $ip46 not found in the chain $chain"
if [ "$chain" == "ALL" ]; then
	check_ip=$(grep "IP='$ip46' CHAIN='*'" "$conf")
	if [ -z "$check_ip" ]; then
		exit
	fi
	grep "IP='$ip46' CHAIN='*'" "$conf" | while read -r line; do
		parse_object_kv_list "$line"
		if [ -x "$subnetcalc_bin" ]; then
			# if subnetcalc binary is installed on system, then ban of whole /64 subnet
			ip2ban="$("$subnetcalc_bin" "${IP}/64" | sed -ne '/Network/s/Network[ \t]*=[ \t]*\(.*\)/\1/p' | sed -e 's/[ \t]*//g')"
		else
			# otherwise ban the ip only, without subnet
			ip2ban="$IP"
		fi
		del_param="$(${iptables} -S | grep -m 1 "fail2ban-$CHAIN.*$ip2ban" | sed -e 's/^-A[ \t]*//')"
		[ -n "$del_param" ] && error_message="$(${iptables} -D $del_param)"
		# Deleting ip from banlist
		sip=$(echo "$IP" | sed "s|/|\\\/|g")
		sed -i "/IP='$sip' CHAIN='$CHAIN'/d" "$conf"
	done
else
	# Checking ip in banlist
	check_ip=$(grep "IP='$ip46' CHAIN='$chain'" "$conf" 2> /dev/null)
	if [ -z "$check_ip" ]; then
		exit
	fi

	del_param="$(${iptables} -S | grep -m 1 "fail2ban-$chain.*$ip2ban" | sed -e 's/^-A[ \t]*//')"
	[ -n "$del_param" ] && error_message="$(${iptables} -D $del_param)"
	if [ $? -ne 0 ]; then
		error_code=$?
		check_result 1 "$error_message"
		exit $error_code
	fi
	# Deleting ip from banlist
	sip=$(echo "$ip46" | sed "s|/|\\\/|g")
	sed -i "/IP='$sip' CHAIN='$chain'/d" "$conf"
fi

# Changing permissions
chmod 660 "$conf"

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Logging
"$BIN/v-log-action" "system" "Info" "Firewall" "Removed IP from ban list (IP: $ip46, Service: $chain)."
log_event "$OK" "$ARGUMENTS"

exit
