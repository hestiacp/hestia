#!/bin/bash
# info: Install RoundCube for Nginx/Apache2 
# options: [MODE]
# labels: hestia
#
# The function installs Round Cube

#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Includes
source $HESTIA/func/main.sh
source $HESTIA/conf/hestia.conf

MODE=$1

# Version and Download paths
RC_V="1.4.10"
RC_FILE="roundcubemail-{$RC_V}-complete.tar.gz"
RC_EXTRACT="roundcubemail-{$RC_V}"
# Downloading full version
RC_URL="https://github.com/roundcube/roundcubemail/releases/download/{$RC_V}/roundcubemail-{$RC_V}-complete.tar.gz"


# Folder paths
RC_INSTALL_DIR="/usr/share/roundcube"
RC_CONFIG_DIR="/etc/roundcube"
RC_LOG="/var/log/roundcube"


#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Checking root permissions
if [ "x$(id -u)" != 'x0' ]; then
    echo "ERROR: v-add-sys-roundcube can be run executed only by root user"
    exit 10
fi

# Ensure that $HESTIA (/usr/local/hestia/) and other variables are valid.
if [ -z "$HESTIA" ]; then
    HESTIA="/usr/local/hestia"
fi

if [ -z "$HOMEDIR" ] || [ -z "$HESTIA_INSTALL_DIR" ]; then
    echo "ERROR: Environment variables not present, installation aborted."
    exit 2
fi

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

rm --recursive --force "$RC_INSTALL_DIR"
mkdir -p "$RC_INSTALL_DIR"
cd "$RC_INSTALL_DIR"

[ ! -f "${RC_INSTALL_DIR}/${RC_FILE}" ] && wget "$RC_URL" --quiet -O "${RC_INSTALL_DIR}/${RC_FILE}"

tar xzf $RC_FILE
cp -rf $RC_EXTRACT/* $RC_INSTALL_DIR
cp -f $HESTIA_INSTALL_DIR/roundcube/main.inc.php $RC_CONFIG_DIR/config.inc.php
cp -f $HESTIA_INSTALL_DIR/roundcube/db.inc.php $RC_CONFIG_DIR/debian-db-roundcube.php
cp -f $HESTIA_INSTALL_DIR/roundcube/config.inc.php $RC_CONFIG_DIR/plugins/password/
cp -f $HESTIA_INSTALL_DIR/roundcube/hestia.php $RC_INSTALL_DIR/plugins/password/drivers/
chmod 640 $RC_CONFIG_DIR/config.inc.php
chown root:www-data $RC_CONFIG_DIR/config.inc.php
chmod 640 $RC_CONFIG_DIR/debian-db-roundcube.php
chown root:www-data $RC_CONFIG_DIR/debian-db-roundcube.php
touch $RC_LOG/errors
chmod 640 $RC_LOG/errors
chown www-data:adm $RC_LOG/errors


if [ $DB_SYSTEM ~= "mysql" ]; then
    # Mysql available on system
    r=$(generate_password)
    rcDesKey="$(openssl rand -base64 30 | tr -d "/" | cut -c1-24)"
    mysql -e "CREATE DATABASE roundcube"
    mysql -e "GRANT ALL ON roundcube.*
     TO roundcube@localhost IDENTIFIED BY '$r'"
    sed -i "s/%password%/$r/g" $RC_CONFIG_DIR/debian-db-roundcube.php
    sed -i "s/%des_key%/$rcDesKey/g" $RC_CONFIG_DIR/config.inc.php
    sed -i "s/localhost/$servername/g" $RC_CONFIG_DIR/plugins/password/config.inc.php
    mysql roundcube < /usr/share/dbconfig-common/data/roundcube/install/mysql
else
    if [ $DB_SYSTEM ~= "pgsql" ]; then
    # Pgsql
    echo "TO DO add support for pgsql"
    fi
fi
    
# Enable Roundcube plugins
cp -f $HESTIA_INSTALL_DIR/roundcube/plugins/config_newmail_notifier.inc.php /etc/roundcube/plugins/newmail_notifier/config.inc.php
cp -f $HESTIA_INSTALL_DIR/roundcube/plugins/config_zipdownload.inc.php /etc/roundcube/plugins/zipdownload/config.inc.php
    
# Fixes for PHP 7.4 compatibility
[ -f "/usr/share/roundcube/plugins/enigma/lib/enigma_ui.php" ] && sed -i 's/$identities, "\\n"/"\\n", $identities/g' /usr/share/roundcube/plugins/enigma/lib/enigma_ui.php
[ -f "/usr/share/roundcube/program/lib/Roundcube/rcube_contacts.php" ] && sed -i 's/(array_keys($post_search), \x27|\x27)/(\x27|\x27, array_keys($post_search))/g' /usr/share/roundcube/program/lib/Roundcube/rcube_contacts.php
[ -f "/usr/share/roundcube/program/lib/Roundcube/rcube_db.php" ] && sed -i 's/implode($name, \x27.\x27)/implode(\x27.\x27, $name)/g' /usr/share/roundcube/program/lib/Roundcube/rcube_db.php
[ -f "/usr/share/roundcube/program/steps/addressbook/search.inc" ] && sed -i 's/$fields, \x27,\x27/\x27,\x27, $fields/g' /usr/share/roundcube/program/steps/addressbook/search.inc
[ -f "/usr/share/roundcube/program/steps/addressbook/search.inc" ] && sed -i 's/implode($fields, \x27,\x27)/implode(\x27,\x27, $fields)/g' /usr/share/roundcube/program/steps/addressbook/search.inc
[ -f "/usr/share/roundcube/program/steps/mail/sendmail.inc" ] && sed -i 's/implode($bstyle, \x27; \x27)/implode(\x27; \x27, $bstyle)/g' /usr/share/roundcube/program/steps/mail/sendmail.inc
    
# Configure webmail alias
echo "WEBMAIL_ALIAS='webmail'" >> $HESTIA/conf/hestia.conf

# Add robots.txt
echo "User-agent: *" > /var/lib/roundcube/robots.txt
echo "Disallow: /" >> /var/lib/roundcube/robots.txt

# Restart services
if [ "$apache" = 'yes' ]; then
    systemctl restart apache2
fi
if [ "$nginx" = 'yes' ]; then
    systemctl restart nginx
fi

#----------------------------------------------------------#
#                       Logging                            #
#----------------------------------------------------------#

log_history "Rouncube successfuly installed" '' 'admin'
log_event "$OK" "$ARGUMENTS"