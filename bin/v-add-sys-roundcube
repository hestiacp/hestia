#!/bin/bash
# info: Install RoundCube for Nginx/Apache2 
# options: [MODE]
# labels: hestia
#
# The function installs Round Cube

#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Includes
source $HESTIA/func/main.sh
source $HESTIA/conf/hestia.conf

MODE=$1

# Version and Download paths
RC_V="1.4.10"
RC_FILE="roundcubemail-$RC_V-complete.tar.gz"
RC_EXTRACT="roundcubemail-$RC_V"
# Downloading full version
RC_URL="https://github.com/roundcube/roundcubemail/releases/download/$RC_V/roundcubemail-$RC_V-complete.tar.gz"

# Folder paths
RC_INSTALL_DIR="/var/lib/roundcube"
RC_CONFIG_DIR="/etc/roundcube"
RC_LOG="/var/log/roundcube"


#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Checking root permissions
if [ "x$(id -u)" != 'x0' ]; then
    echo "ERROR: v-add-sys-roundcube can be run executed only by root user"
    exit 10
fi

# Ensure that $HESTIA (/usr/local/hestia/) and other variables are valid.
if [ -z "$HESTIA" ]; then
    HESTIA="/usr/local/hestia"
fi

if [ -z "$HOMEDIR" ] || [ -z "$HESTIA_INSTALL_DIR" ]; then
    echo "ERROR: Environment variables not present, installation aborted."
    exit 2
fi

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

rm --recursive --force $RC_INSTALL_DIR
rm --recursive --force $RC_CONFIG_DIR
mkdir -p $RC_INSTALL_DIR/
mkdir -p $RC_CONFIG_DIR/

cd "$RC_INSTALL_DIR"

[ ! -f "${RC_INSTALL_DIR}/${RC_FILE}" ] && wget "$RC_URL" --quiet -O "${RC_INSTALL_DIR}/${RC_FILE}"

tar xzf $RC_FILE
cp -rf $RC_EXTRACT/* $RC_INSTALL_DIR

# Delete old config folder
cp $RC_INSTALL_DIR/config/defaults.inc.php $RC_CONFIG_DIR/defaults.inc.php
rm -f -r $RC_INSTALL_DIR/config/
ln -s /etc/roundcube/ ./config
# Replace with Hestia config
cp -f $HESTIA_INSTALL_DIR/roundcube/main.inc.php $RC_CONFIG_DIR/config.inc.php
cp -f $HESTIA_INSTALL_DIR/roundcube/mimetypes.php $RC_CONFIG_DIR/mimetypes.php

cp -f $HESTIA_INSTALL_DIR/roundcube/hestia.php $RC_INSTALL_DIR/plugins/password/drivers/
mkdir -p $RC_CONFIG_DIR/plugins/password
mkdir -p $RC_CONFIG_DIR/plugins/newmail_notifier
mkdir -p $RC_CONFIG_DIR/plugins/zipdownload

# Allow changes to the respecitive config / Create symlinks to /etc/roundcube/ 
cp -f $HESTIA_INSTALL_DIR/roundcube/config.inc.php $RC_CONFIG_DIR/plugins/password/config.inc.php
ln -s $RC_CONFIG_DIR/plugins/password/config.inc.php ./plugins/password/config.inc.php
cp -f $HESTIA_INSTALL_DIR/roundcube/plugins/config_newmail_notifier.inc.php $RC_CONFIG_DIR/plugins/newmail_notifier/config.inc.php
ln -s $RC_CONFIG_DIR/plugins/newmail_notifier/config.inc.php ./plugins/newmail_notifier/config.inc.php
cp -f $HESTIA_INSTALL_DIR/roundcube/plugins/config_zipdownload.inc.php $RC_CONFIG_DIR/plugins/zipdownload/config.inc.php
ln -s $RC_CONFIG_DIR/plugins/zipdownload/config.inc.php ./plugins/zipdownload/config.inc.php


chmod 640 $RC_CONFIG_DIR/config.inc.php
chown root:www-data $RC_CONFIG_DIR/config.inc.php

# Log file 
if [ ! -d  $RC_LOG ];then
    mkdir $RC_LOG
fi
chown www-data:root $RC_LOG
chmod 751 $RC_LOG

if [ ! -z "$(echo "$DB_SYSTEM" | grep -w 'mysql')" ]; then
    # Remove the following 2 lines when going live
    mysql -e "DROP DATABASE roundcube"
    mysql -e "DROP USER roundcube@localhost"
    # Mysql available on system
    r=$(generate_password)
    mysql -e "CREATE DATABASE roundcube"
    mysql -e "GRANT ALL ON roundcube.*
     TO roundcube@localhost IDENTIFIED BY '$r'"
    sed -i "s/%password%/$r/g" $RC_CONFIG_DIR/config.inc.php
    mysql roundcube < /usr/share/roundcube/SQL/mysql.initial.sql
fi

rcDesKey="$(openssl rand -base64 30 | tr -d "/" | cut -c1-24)"
sed -i "s/%des_key%/$rcDesKey/g" $RC_CONFIG_DIR/config.inc.php
# Change hostname for password change
sed -i "s/localhost/$(hostname)/g" $RC_CONFIG_DIR/plugins/password/config.inc.php

# Add robots.txt
echo "User-agent: *" > /var/lib/roundcube/robots.txt
echo "Disallow: /" >> /var/lib/roundcube/robots.txt

phpenmod mcrypt > /dev/null 2>&1

#----------------------------------------------------------#
#                       Logging                            #
#----------------------------------------------------------#



log_history "Rouncube successfuly installed" '' 'admin'
log_event "$OK" "$ARGUMENTS"