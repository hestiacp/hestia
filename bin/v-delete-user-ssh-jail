#!/bin/bash
# info: delete user ssh jail
# options: USER
#
# example: v-delete-user-ssh-jail whistler
#
# This function disables ssh jailed environment for USER

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'USER'
is_format_valid 'user'
user_str=$(grep "^$user:" /etc/passwd)
if [ -z "$user_str" ]; then
	exit
fi

# Check if jail exist
if [[ "$user_groups" =~ "ssh-jailed" ]]; then
	exit
fi

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# chown permissions back to user:user
if [ -d "/home/$user" ]; then
	chown $user:$user /home/$user
fi

# Deleting chroot jail for SSH
delete_chroot_jail $user

# Deleting user from groups
gpasswd -d $user ssh-jailed >/dev/null 2>&1

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Restart ssh service
service sshd restart > /dev/null 2>&1

# Logging
log_event "$OK" "$ARGUMENTS"

exit
