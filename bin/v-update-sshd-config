#!/bin/bash
# info: update sshd config
# options: NONE
#
# The functions updates the sshd config file


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument definition
sshd_config=/etc/ssh/sshd_config

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#



#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Keep the following actions maintained in sync with the current install scripts
sshd_config_augtool = /files/etc/ssh/sshd_config

# Alaways save a backup copy of the config file if it has changed directly in the same directory
# to permit fast audit, diff and recovery if required
# cp options: "-u" only copy if newer, "--backup=t" numbered backup, destination is hidden and has .bak extension.
cp -u --backup=t /etc/ssh/sshd_config /etc/ssh/.sshd_config.bak

# Important PasswordAuthentication: Previous versions of HestiaCP and VestaCP had imposed 'PasswordAuthentication yes'
# However, this would be risky to change during an update as it is probable that installs have changed this setting
# and changing it could completely lock out all sshd access.

# Enable SFTP subsystem for SSH
sftp_subsys_enabled=$(grep -iE "^#?.*subsystem.+(sftp )?sftp-server" $sshd_config)
if [ ! -z "$sftp_subsys_enabled" ]; then
    sed -i -E "s/^#?.*Subsystem.+(sftp )?sftp-server/Subsystem sftp internal-sftp/g" $sshd_config
fi

# Remove DebianBanner setting.  Previous versions of HestiaCP had imposed this to 'DebianBanner no'
augtool -s rm $sshd_config_augtool/DebianBanner 

# Reduce SSH login grace time
augtool -s set $sshd_config_augtool/LoginGraceTime 1m 


#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Logging
# Maybe add this to the log?
#log_event "$OK" "$ARGUMENTS"

exit
